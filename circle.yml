machine:

  services:
    - docker

  pre:
    - sudo rm -rf /usr/local/go
    - curl -L https://storage.googleapis.com/golang/go1.8.linux-amd64.tar.gz | sudo tar xvzf - -C /usr/local

  environment:
    PATH: "/usr/local/go/bin:/usr/local/go_workspace/bin:~/.g /home/ubuntu/.go_project_workspace/bin:${PATH}"
    GOPATH: "${HOME}/go"
    SOURCES: $GOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME 
    WORKDIR: $SOURCES/$CIRCLE_PROJECT_REPONAME

  post:
    - mkdir -p $GOPATH
    - mkdir -p $WORKDIR
    - cp -r $HOME/$CIRCLE_PROJECT_REPONAME $SOURCES


dependencies:

  override:
    - cd $WORKDIR && make deps
    - go get -u github.com/golang/lint/golint

  post:
    - cd $WORKDIR && make docker-build
    - cd $WORKDIR && docker build -t $AWS_ACCOUNT_ID.dkr.ecr.eu-west-2.amazonaws.com/picsou:$CIRCLE_SHA1 -f $WORKDIR/Dockerfile .


test:

  override:
    - cd $WORKDIR && make lint
    - cd $WORKDIR && make cover

  post:
    - mkdir $CIRCLE_ARTIFACTS/coverage
    - mv $WORKDIR/coverage.txt $CIRCLE_ARTIFACTS/coverage
    - mv $WORKDIR/coverage.html $CIRCLE_ARTIFACTS/coverage

deployment:

  prod:
    branch: master
    commands:
      - ./deploy.sh
